name: Build, Scan & Push Docker Image on Release

on:
  release:
    types: [published]
  schedule:
    - cron: "0 3 * * *" # Tous les jours √† 03h00 UTC
  workflow_dispatch:       # permet de lancer manuellement aussi
        
jobs:
  download-geoip:
    runs-on: ubuntu-latest
    steps:      
      # T√©l√©charger le fichier GeoIP
      - name: Download GeoIP database
        env:
          TOKEN_IPINFO: ${{ secrets.TOKEN_IPINFO }}
        run: |
          mkdir -p custom_data
                   
          # T√©l√©charger avec headers pour voir l'erreur
          curl -i -L -o /tmp/location.mmdb.gz "https://ipinfo.io/data/ipinfo_lite.mmdb?token=${TOKEN_IPINFO}" 2>&1 | head -30          

          if [ ! -f "/tmp/location.mmdb.gz" ]; then
            echo "‚ùå Erreur: location.mmdb.gz non t√©l√©charg√©"
            exit 1
          fi
          
          # V√©rifier le type de fichier
          echo "üìã Type de fichier:"
          file /tmp/location.mmdb.gz
          
          filesize=$(du -h /tmp/location.mmdb.gz | cut -f1)
          echo "üì¶ Taille: $filesize"
          
          # V√©rifier si c'est vraiment du gzip (et pas une erreur)
          if file /tmp/location.mmdb.gz | grep -q "gzip"; then
            echo "‚úÖ Format gzip d√©tect√©, d√©compression..."
            gzip -d /tmp/location.mmdb.gz
            mv /tmp/location.mmdb ./custom_data/location.mmdb
            echo "‚úÖ Fichier pr√™t: $(du -h ./custom_data/location.mmdb | cut -f1)"
          else
            echo "‚ùå Erreur: Le fichier n'est pas en gzip"
            echo "Contenu re√ßu:"
            cat /tmp/location.mmdb.gz
            exit 1
          fi

      # Upload en artifact
      - name: Upload custom data
        uses: actions/upload-artifact@v4
        with:
          name: custom_data
          path: custom_data/location.mmdb

  call-central:
    needs: download-geoip
    uses: veka-server/github-actions-templates/.github/workflows/docker-build.yml@main
    secrets:
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
