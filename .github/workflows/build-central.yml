name: Build, Scan & Push Docker Image on Release

on:
  release:
    types: [published]
  schedule:
    - cron: "0 3 * * *" # Tous les jours √† 03h00 UTC
  workflow_dispatch:       # permet de lancer manuellement aussi
        
jobs:
  download-geoip:
    runs-on: ubuntu-latest
    steps:
      
      # Installer les d√©pendances n√©cessaires
      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl gzip
      
      # T√©l√©charger le fichier GeoIP
      - name: Download GeoIP database
        env:
          TOKEN_IPINFO: ${{ secrets.TOKEN_IPINFO }}
        run: |
          mkdir -p custom_data
          
          echo "üîç Tentative de t√©l√©chargement..."
          echo "URL: https://ipinfo.io/data/location.mmdb.gz?token=${TOKEN_IPINFO}"
          
          # T√©l√©charger avec headers pour voir l'erreur
          curl -i -L -o /tmp/location.mmdb.gz "https://ipinfo.io/data/location.mmdb.gz?token=${TOKEN_IPINFO}" 2>&1 | head -30
          
          echo ""
          echo "üìÑ Contenu du fichier t√©l√©charg√©:"
          cat /tmp/location.mmdb.gz
          echo ""
          
          if [ ! -f "/tmp/location.mmdb.gz" ]; then
            echo "‚ùå Erreur: location.mmdb.gz non t√©l√©charg√©"
            exit 1
          fi
          echo "‚úÖ GeoIP database t√©l√©charg√© ($(du -h /tmp/location.mmdb.gz | cut -f1))"

          # D√©compresser
          gzip -d /tmp/location.mmdb.gz 
          
          # V√©rifier que le fichier d√©compress√© existe
          if [ ! -f "/tmp/location.mmdb" ]; then
            echo "‚ùå Erreur: decompression √©chou√©e"
            exit 1
          fi
          
          mv /tmp/location.mmdb ./custom_data/location.mmdb 
          echo "‚úÖ Fichier pr√™t: $(du -h ./custom_data/location.mmdb | cut -f1)"

      # Upload en artifact
      - name: Upload custom data
        uses: actions/upload-artifact@v4
        with:
          name: custom_data
          path: custom_data/location.mmdb

  call-central:
    uses: veka-server/github-actions-templates/.github/workflows/docker-build.yml@main
    secrets:
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
