name: Build, Scan & Push Docker Image on Release

on:
  release:
    types: [published]
  schedule:
    - cron: "0 3 * * *" # Tous les jours à 03h00 UTC
  workflow_dispatch:       # permet de lancer manuellement aussi
        
jobs:
  download-geoip:
    runs-on: ubuntu-latest
    steps:      
      # Télécharger le fichier GeoIP
      - name: Download GeoIP database
        env:
          TOKEN_IPINFO: ${{ secrets.TOKEN_IPINFO }}
        run: |
          mkdir -p custom_data
                   
          # Télécharger avec headers pour voir l'erreur
          curl -i -L -o /tmp/location.mmdb "https://ipinfo.io/data/ipinfo_lite.mmdb?token=${TOKEN_IPINFO}" 2>&1 | head -30          

          if [ ! -f "/tmp/location.mmdb" ]; then
            echo "❌ Erreur: location.mmdb.gz non téléchargé"
            exit 1
          fi

          mv /tmp/location.mmdb ./custom_data/location.mmdb
          echo "✅ Fichier prêt: $(du -h ./custom_data/location.mmdb | cut -f1)"

      # Upload en artifact
      - name: Upload custom data
        uses: actions/upload-artifact@v4
        with:
          name: custom_data
          path: custom_data/location.mmdb

  call-central:
    needs: download-geoip
    uses: veka-server/github-actions-templates/.github/workflows/docker-build.yml@main
    secrets:
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
