name: Build, Scan & Push Docker Image on Release

on:
  release:
    types: [published]
  schedule:
    - cron: "0 3 * * *" # Tous les jours à 03h00 UTC
  workflow_dispatch:       # permet de lancer manuellement aussi
        
jobs:
  download-geoip:
    runs-on: ubuntu-latest
    steps:      
      # Télécharger le fichier GeoIP
      - name: Download GeoIP database
        env:
          TOKEN_IPINFO: ${{ secrets.TOKEN_IPINFO }}
        run: |
          set -e
          mkdir -p custom_data
          
          echo "Téléchargement de la base GeoIP depuis ipinfo.io..."
          curl -s -L -o /tmp/location.mmdb "https://ipinfo.io/data/ipinfo_lite.mmdb?token=${TOKEN_IPINFO}"

          echo "Téléchargement du fichier de checksums..."
          curl -s -L -o /tmp/checksums.json "https://ipinfo.io/data/ipinfo_lite.mmdb/checksums?token=${TOKEN_IPINFO}"

          # Vérifier que le fichier existe et a une taille suffisante (par sécurité)
          if [ ! -s "/tmp/location.mmdb" ]; then
            echo "Erreur: location.mmdb vide ou manquant"
            exit 1
          fi

          echo "Fichier téléchargé: $(du -h /tmp/location.mmdb | cut -f1)"

          # Extraire le SHA256 attendu depuis le JSON
          EXPECTED_SHA256=$(jq -r '.checksums.sha256' /tmp/checksums.json)
          echo "SHA256 attendu: $EXPECTED_SHA256"

          # Calculer le SHA256 réel
          ACTUAL_SHA256=$(sha256sum /tmp/location.mmdb | awk '{print $1}')
          echo "SHA256 réel:    $ACTUAL_SHA256"

          # Comparer les deux
          if [ "$EXPECTED_SHA256" != "$ACTUAL_SHA256" ]; then
            echo "Le checksum ne correspond pas. Téléchargement corrompu."
            exit 1
          fi

          echo "Vérification réussie. Déplacement du fichier..."
          mv /tmp/location.mmdb ./custom_data/location.mmdb
          echo "Fichier prêt: $(du -h ./custom_data/location.mmdb | cut -f1)"

      # Upload en artifact
      - name: Upload custom data
        uses: actions/upload-artifact@v4
        with:
          name: custom_data
          path: custom_data/location.mmdb

  call-central:
    needs: download-geoip
    uses: veka-server/github-actions-templates/.github/workflows/docker-build.yml@main
    secrets:
      GHCR_PAT: ${{ secrets.GHCR_PAT }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
